<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title></title>

    <style>
        body {
            font-family: sans-serif;
        }

        #modal {
            display: none;
            background-color: black;
            color: white;
            opacity: .8;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            line-height: 100%;
            padding-top: 20%;
            text-align: center;
        }
    </style>

    <script type="text/javascript" src="swfobject.js"></script>
    <script>
        var noCameraPoster =
            'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIj8+PHN2ZyB3aWR0aD0iMjQwLjAwMDAwMDAwMDAwMDAzIiBoZWlnaHQ9IjEzNSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczpzdmc9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4gPGc+ICA8dGl0bGU+TGF5ZXIgMTwvdGl0bGU+ICA8cmVjdCBpZD0ic3ZnXzMiIGhlaWdodD0iMTM1IiB3aWR0aD0iMjQwIiB5PSIwIiB4PSIwIiBzdHJva2UtbGluZWNhcD0ibnVsbCIgc3Ryb2tlLWxpbmVqb2luPSJudWxsIiBzdHJva2UtZGFzaGFycmF5PSJudWxsIiBzdHJva2Utd2lkdGg9Im51bGwiIGZpbGw9IiMwMDAwMDAiLz4gIDxwYXRoIGZpbGw9IiNmZmZmZmYiIGlkPSJzdmdfMiIgZD0ibTE0NC44OTg0MzgsNTQuMzk1NTU5bC0xMC40ODM1NTMsMTAuNDgzNTUzbDAsLTkuMTczMTA5YzAsLTEuNDQxNDg5IC0xLjE3OTQsLTIuNjIwODg4IC0yLjYyMDg4OCwtMi42MjA4ODhsLTE2LjE5NzA4OSwwbDI5LjMwMTUzLDI5LjMwMTUzbDAsLTI3Ljk5MTA4NnptLTQ2LjQ2ODM0OCwtMTEuNzkzOTk3bC0zLjMyODUyOCwzLjMyODUyOGw3LjE1NTAyNSw3LjE1NTAyNWwtMS45MTMyNDgsMGMtMS40NDE0ODksMCAtMi42MjA4ODgsMS4xNzk0IC0yLjYyMDg4OCwyLjYyMDg4OGwwLDI2LjIwODg4MmMwLDEuNDQxNDg5IDEuMTc5NCwyLjYyMDg4OCAyLjYyMDg4OCwyLjYyMDg4OGwzMS40NTA2NTksMGMwLjU1MDM4NywwIDEuMDIyMTQ2LC0wLjIwOTY3MSAxLjQxNTI4LC0wLjQ3MTc2bDguMzYwNjMzLDguMzM0NDI1bDMuMzI4NTI4LC0zLjMyODUyOGwtNDYuNDY4MzQ4LC00Ni40NjgzNDh6Ii8+IDwvZz48L3N2Zz4=';

        function $(id) {
            return document.getElementById(id);
        }

        ////////////////////////////////////
        // GENERIC
        ////////////////////////////////////

        var getUserMedia,
            releaseUserMedia;

        function changeUserMedia() {Â 
            var camId = $('camId').options[$('camId').selectedIndex].value;
            var micId = $('micId').options[$('micId').selectedIndex].value;
            connectUrlExtra = (camId ? '&camId=' + camId : '') + (micId ? '&micId=' + micId : '');

            console.log('Changing input devices', camId, micId);

            if (releaseUserMedia) {
                releaseUserMedia();
            }
            getUserMedia(camId, micId)
        }

        ////////////////////////////////////
        // WEBRTC
        ////////////////////////////////////

        navigator.getUserMedia = (
            navigator.getUserMedia ||
            navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia ||
            navigator.msGetUserMedia);

        var url = window.URL || window.webkitURL || window.mozURL;

        var analyzer,
            audioContext,
            audioInterval,
            mediaStreamSource,
            localMediaStream;

        if (window.AudioContext) {
            audioContext = new window.AudioContext();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 1024;
            analyser.smoothingTimeConstant = 0.5;
        }

        var hasEnumeratedWebRtcDevices = false;

        function enumerateWebrtcDevices() {
            if (!hasEnumeratedWebRtcDevices && navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                hasEnumeratedWebRtcDevices = true;
                navigator.mediaDevices.enumerateDevices().then(function(devices) {
                    devices.forEach(function(device) {
                        var option = document.createElement("option");
                        option.value = device.deviceId;
                        option.innerHTML = device.label;
                        switch (device.kind) {
                            case 'videoinput':
                                camId.appendChild(option);
                                break;
                            case 'audioinput':
                                micId.appendChild(option);
                                break;
                            default:
                        }
                    });
                })
            }
        }

        function getWebrtcUserMedia(camId, micId) {
            // $('videoPreview').poster = noCameraPoster;

            function videoEnded(e) {
                console.log("Video ended", e)
                $('videoPreview').src = '';
                $('videoPreview').poster = noCameraPoster;
            }
            $('videoPreview').onended = videoEnded;
            $('videoPreview').onplay = function() {
                console.log("Video playing")
                this.poster = '';
            }
            var constraints = {
                video: {
                    optional: [{
                        minWidth: 320
                    }, {
                        minWidth: 640
                    }, {
                        minWidth: 1024
                    }, {
                        minWidth: 1280
                    }]
                },
                audio: {
                    optional: []
                }
            };
            if (camId) {
                constraints.video.optional.push({
                    sourceId: camId
                });
            }
            if (micId) {
                constraints.audio.optional.push({
                    sourceId: micId
                });
            }

            modal.textContent = 'Please allow access to your camera and microphone';
            modal.style.display = 'block';
            navigator.getUserMedia(constraints,
                function(stream) {
                    localMediaStream = stream;
                    console.log('Got WebRTC local media stream', constraints, localMediaStream.getTracks());
                    modal.style.display = 'none';
                    $('videoPreview').src = url.createObjectURL(localMediaStream);

                    enumerateWebrtcDevices();

                    var videoStream = localMediaStream.getVideoTracks().shift();
                    if (videoStream) {
                        videoStream.onended = videoEnded;
                    } else {
                        videoEnded();
                    }

                    if (window.AudioContext) {
                        try {
                            console.log('Starting WebRTC audio level indicator');
                            mediaStreamSource = audioContext.createMediaStreamSource(localMediaStream);
                            mediaStreamSource.connect(analyser);

                            audioInterval = window.setInterval(function() {
                                if (audioContext.state === 'suspended') {
                                    audioContext.resume();
                                }
                                var array = new Uint8Array(analyser.frequencyBinCount);
                                analyser.getByteFrequencyData(array);
                                var values = 0;

                                var length = array.length;
                                for (var i = 0; i < length; i++) {
                                    values += array[i];
                                }
                                audioLevel.style.width = Math.min(100, values / length) + '%';
                            }, 100);

                            analyser.disconnect();
                        } catch (e) {
                            console.log('Failed to create media stream source for audio context', e);
                        }
                    }
                },
                function(err) {
                    console.log(err);
                    modal.style.color = '#c00';
                    modal.textContent = 'Unable to access your camera and/or microphone';
                }
            );
        }

        function releaseWebrtcUserMedia() {
            console.log('Stopping WebRTC audio level indicator');

            window.clearInterval(audioInterval);

            if (mediaStreamSource) {
                mediaStreamSource.disconnect();
                mediaStreamSource = null;
            }
            if (analyser) {
                analyser.disconnect();
            }

            console.log('Releasing WebRTC local media stream');
            if (localMediaStream) {
                localMediaStream.getTracks().forEach(function(track) {
                    track.stop();
                });
            }
        };

        ////////////////////////////////////
        // FLASH
        ////////////////////////////////////

        function enumerateFlashDevices() {
            $('flashVideoPreview').enumerateVideoSources().forEach(function(label, id) {
                var option = document.createElement("option");
                option.value = id;
                option.innerHTML = label;
                $('camId').appendChild(option);
            });
            $('flashVideoPreview').enumerateAudioSources().forEach(function(label, id) {
                var option = document.createElement("option");
                option.value = id;
                option.innerHTML = label;
                $('micId').appendChild(option);
            });
        }

        function getFlashUserMedia(camId, micId) {
            $('flashVideoPreview').setSelfviewRatio(1);
            $('flashVideoPreview').initCamera(camId);
            $('flashVideoPreview').initMicrophone(micId);
            $('flashVideoPreview').showSelfview();
        }

        function releaseFlashUserMedia() {
            $('flashVideoPreview').hideSelfview();
        }

        window.flash_is_ready = function _flashIsReady() {
            getUserMedia = getFlashUserMedia;
            releaseUserMedia = releaseFlashUserMedia;
            enumerateFlashDevices();
            getFlashUserMedia(false, false);

            var flashMicrophoneInterval = window.setInterval(function() {
                try {
                    var mediaStats = $('flashVideoPreview').getMediaStatistics();
                    $('audioLevel').style.width = Math.min(100, mediaStats.Outgoing.Audio.Level) + '%';
                } catch (e) {
                    window.clearInterval(flashMicrophoneInterval);
                }
            }, 100);

            delete window.flash_is_ready;
        };

        ////////////////////////////////////
        // INITIALIZATION STUFF
        ////////////////////////////////////

        var connectUrl,
            connectUrlExtra;

        function init() {
            if (navigator.getUserMedia) {
                connectUrl = 'conference.html' + window.location.search;
                videoPlaceholder.innerHTML = '<video id="videoPreview" autoplay muted width="512"></video>';
                getUserMedia = function(camId, micId) {
                    // If we re-request media before it is released it usually fails,
                    // so add a timeout to wait (since we do not have a callback to pin this on)
                    window.setTimeout(function() {
                        getWebrtcUserMedia(camId, micId);
                    }, 500);
                }
                releaseUserMedia = releaseWebrtcUserMedia;
                getUserMedia();
            } else {
                connectUrl = 'conference-flash.html' + window.location.search;
                swfobject.embedSWF(
                    '/static/webrtc/flash/PexVideo.swf',
                    'videoPlaceholder',
                    512,
                    288,
                    '11.1.0',
                    'playerProductInstall.swf', {}, {
                        quality: 'high',
                        bgcolor: '#262626',
                        allowscriptaccess: 'always',
                        allowfullscreen: 'true',
                        wmode: 'transparent',
                        scale: 'exactFit',
                    }, {
                        id: 'flashVideoPreview',
                        name: 'PexVideo',
                        align: 'middle',
                    });
            }
        }

        window.onbeforeunload = function() {
            if (releaseUserMedia) {
                releaseUserMedia();
            }
        }
    </script>
</head>

<body onload="init()">
    <h2>Video Preview</h2>
    <div>
        <select id="camId" onchange="changeUserMedia()">
            <option selected="selected" value="">[Use browser default camera]</option>
        </select>
    </div>
    <div id="videoPlaceholder"></div>

    <h2>Audio Level Indication</h2>
    <div>
        <select id="micId" onchange="changeUserMedia()">
            <option selected="selected" value="">[Use browser default microphone]</option>
        </select>
    </div>
    <div style="width: 512px; background-color: #a00; ">
        <div id="audioLevel" style="width: 0; height: 10px; background-color: #0a0; transition: width 0.1s linear">
        </div>
    </div>

    <div style="margin: 5em;">
        <input type="button" onclick="window.location.href = 'index.html'" value="Cancel" />
        <input type="button" onclick="window.location.href = connectUrl + connectUrlExtra" value="Connect" />
    </div>

    <div id="modal"></div>
</body>

</html>
